<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCU Molecular Innovative Bartending Research Society - Bar Simulator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: #000;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #dialogue-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 130, 0.9));
            color: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(138, 43, 226, 0.5);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        #dialogue-box h3 {
            margin: 0 0 10px 0;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        #interaction-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.9);
            color: #333;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div id="loading">載入中...</div>
        <canvas id="bar-canvas"></canvas>
        <div id="controls">
            <strong>控制說明:</strong> WASD - 移動 | ← → - 左右轉向 | E - 互動
        </div>
        <div id="dialogue-box">
            <h3 id="character-name"></h3>
            <p id="dialogue-text"></p>
        </div>
        <div id="interaction-hint">按 E 互動</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // 模組化的酒吧模擬器
        class BarSimulator {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.clock = new THREE.Clock();
                
                // 玩家狀態
                this.player = {
                    position: new THREE.Vector3(0, 1.6, 5),
                    rotation: 0,
                    speed: 5,
                    rotationSpeed: 2
                };
                
                // 輸入狀態
                this.keys = {};
                
                // NPC 資料
                this.npcs = [];
                this.interactableObjects = [];
                
                this.init();
            }
            
            init() {
                this.setupScene();
                this.createBar();
                this.createNPCs();
                this.setupLighting();
                this.setupEventListeners();
                this.animate();
                
                // 隱藏載入提示
                document.getElementById('loading').style.display = 'none';
            }
            
            setupScene() {
                // 場景設定
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.Fog(0x1a0033, 10, 30);
                
                // 相機設定
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    1000
                );
                this.camera.position.copy(this.player.position);
                
                // 渲染器設定
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: document.getElementById('bar-canvas'),
                    antialias: true 
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            }
            
            createBar() {
                // 地板
                const floorGeometry = new THREE.PlaneGeometry(20, 20);
                const floorMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x2c1810,
                    shininess: 30
                });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                this.scene.add(floor);
                
                // 牆壁
                this.createWalls();
                
                // 吧檯
                this.createBarCounter();
                
                // 酒架
                this.createLiquorShelf();
                
                // 吧檯椅
                this.createBarStools();
            }
            
            createWalls() {
                const wallMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x4a3c28,
                    shininess: 10
                });
                
                // 後牆
                const backWall = new THREE.Mesh(
                    new THREE.PlaneGeometry(20, 10),
                    wallMaterial
                );
                backWall.position.set(0, 5, -10);
                backWall.receiveShadow = true;
                this.scene.add(backWall);
                
                // 左牆
                const leftWall = new THREE.Mesh(
                    new THREE.PlaneGeometry(20, 10),
                    wallMaterial
                );
                leftWall.position.set(-10, 5, 0);
                leftWall.rotation.y = Math.PI / 2;
                leftWall.receiveShadow = true;
                this.scene.add(leftWall);
                
                // 右牆
                const rightWall = new THREE.Mesh(
                    new THREE.PlaneGeometry(20, 10),
                    wallMaterial
                );
                rightWall.position.set(10, 5, 0);
                rightWall.rotation.y = -Math.PI / 2;
                rightWall.receiveShadow = true;
                this.scene.add(rightWall);
            }
            
            createBarCounter() {
                // 吧檯主體
                const counterGeometry = new THREE.BoxGeometry(12, 1.2, 2);
                const counterMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x8b4513,
                    shininess: 60
                });
                const counter = new THREE.Mesh(counterGeometry, counterMaterial);
                counter.position.set(0, 1.2, -3);
                counter.castShadow = true;
                counter.receiveShadow = true;
                this.scene.add(counter);
                
                // 吧檯表面（大理石紋理效果）
                const topGeometry = new THREE.BoxGeometry(12.2, 0.1, 2.2);
                const topMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xf0f0f0,
                    shininess: 100
                });
                const counterTop = new THREE.Mesh(topGeometry, topMaterial);
                counterTop.position.set(0, 1.85, -3);
                this.scene.add(counterTop);
            }
            
            createLiquorShelf() {
                // 酒架背板
                const shelfBack = new THREE.Mesh(
                    new THREE.BoxGeometry(10, 6, 0.3),
                    new THREE.MeshPhongMaterial({ color: 0x654321 })
                );
                shelfBack.position.set(0, 4, -8.5);
                shelfBack.castShadow = true;
                this.scene.add(shelfBack);
                
                // 創建多層酒架
                for (let i = 0; i < 4; i++) {
                    const shelf = new THREE.Mesh(
                        new THREE.BoxGeometry(10, 0.2, 1),
                        new THREE.MeshPhongMaterial({ color: 0x8b4513 })
                    );
                    shelf.position.set(0, 2 + i * 1.3, -8);
                    shelf.castShadow = true;
                    this.scene.add(shelf);
                    
                    // 在每層架子上放酒瓶
                    this.createBottles(2 + i * 1.3);
                }
                
                // 創建調酒器具
                this.createBarTools();
            }
            
            createBottles(shelfHeight) {
                const bottleColors = [0x2e7d32, 0xc62828, 0xf57c00, 0x1565c0, 0x6a1b9a];
                
                for (let i = 0; i < 8; i++) {
                    // 酒瓶主體
                    const bottleGroup = new THREE.Group();
                    
                    const bottle = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.15, 0.2, 0.8),
                        new THREE.MeshPhongMaterial({ 
                            color: bottleColors[Math.floor(Math.random() * bottleColors.length)],
                            transparent: true,
                            opacity: 0.8,
                            shininess: 100
                        })
                    );
                    
                    // 瓶頸
                    const neck = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.08, 0.15, 0.3),
                        new THREE.MeshPhongMaterial({ color: 0x333333 })
                    );
                    neck.position.y = 0.55;
                    
                    // 瓶蓋
                    const cap = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.09, 0.09, 0.1),
                        new THREE.MeshPhongMaterial({ color: 0x666666 })
                    );
                    cap.position.y = 0.75;
                    
                    bottleGroup.add(bottle);
                    bottleGroup.add(neck);
                    bottleGroup.add(cap);
                    bottleGroup.position.set(-4 + i * 1.1, shelfHeight + 0.5, -7.8);
                    bottleGroup.castShadow = true;
                    
                    this.scene.add(bottleGroup);
                }
            }
            
            createBarTools() {
                // Shaker
                const shaker = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.2, 0.25, 1),
                    new THREE.MeshPhongMaterial({ 
                        color: 0xc0c0c0,
                        shininess: 100,
                        metalness: 0.8
                    })
                );
                shaker.position.set(-2, 2.3, -3);
                shaker.castShadow = true;
                this.scene.add(shaker);
                
                // Jigger (量酒器)
                const jigger = new THREE.Mesh(
                    new THREE.ConeGeometry(0.15, 0.4),
                    new THREE.MeshPhongMaterial({ 
                        color: 0xffd700,
                        shininess: 100
                    })
                );
                jigger.position.set(-1, 2.1, -3);
                jigger.castShadow = true;
                this.scene.add(jigger);
                
                // Bar spoon (攪拌匙)
                const spoonHandle = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.02, 0.02, 1.5),
                    new THREE.MeshPhongMaterial({ color: 0xc0c0c0 })
                );
                spoonHandle.position.set(1, 2.5, -3);
                spoonHandle.rotation.z = Math.PI / 6;
                this.scene.add(spoonHandle);
            }
            
            createBarStools() {
                for (let i = 0; i < 4; i++) {
                    const stool = new THREE.Group();
                    
                    // 座椅
                    const seat = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.4, 0.35, 0.1),
                        new THREE.MeshPhongMaterial({ color: 0x8b0000 })
                    );
                    seat.position.y = 0.8;
                    
                    // 椅腿
                    for (let j = 0; j < 4; j++) {
                        const leg = new THREE.Mesh(
                            new THREE.CylinderGeometry(0.03, 0.03, 0.8),
                            new THREE.MeshPhongMaterial({ color: 0x333333 })
                        );
                        const angle = (j / 4) * Math.PI * 2;
                        leg.position.set(
                            Math.cos(angle) * 0.25,
                            0.4,
                            Math.sin(angle) * 0.25
                        );
                        stool.add(leg);
                    }
                    
                    stool.add(seat);
                    stool.position.set(-3 + i * 2, 0, 0);
                    stool.castShadow = true;
                    this.scene.add(stool);
                }
            }
            
            createNPCs() {
                // Gustave - 分子調酒專家
                this.createNPC({
                    name: 'Gustave',
                    position: new THREE.Vector3(2, 0, -2),
                    color: 0x0066cc,
                    dialogues: [
                        "嗨！我是 Gustave，NCU 分子創新調酒研究社的共同創辦人！",
                        "你知道嗎？分子調酒運用了球晶化技術，可以把液體變成像魚子醬一樣的小球！",
                        "我們使用海藻酸鈉和氯化鈣來創造驚人的質地變化。",
                        "想像一下，威士忌做成的泡沫，或是會在嘴裡爆開的莫吉托球！",
                        "分子調酒不只是技術，更是科學與藝術的完美結合！"
                    ]
                });
                
                // Seaton - 調酒技術大師
                this.createNPC({
                    name: 'Seaton',
                    position: new THREE.Vector3(-2, 0, -2),
                    color: 0xcc0066,
                    dialogues: [
                        "哈囉！我是 Seaton，也是社團的共同創辦人！",
                        "調酒最重要的是平衡 - 酸、甜、苦、烈的完美比例。",
                        "你知道搖盪法和攪拌法的差別嗎？含果汁的要搖，純酒精的要攪！",
                        "溫度控制超級重要！冰塊的大小會影響稀釋速度。",
                        "我最喜歡的是經典的 Old Fashioned，簡單卻充滿深度！"
                    ]
                });
                
                // 其他成員
                this.createNPC({
                    name: '社團成員小明',
                    position: new THREE.Vector3(0, 0, 2),
                    color: 0x00cc66,
                    dialogues: [
                        "歡迎來到我們的分子調酒實驗室！",
                        "我剛學會用液態氮做煙霧效果，超酷的！",
                        "社團每週三晚上有聚會，歡迎來玩！",
                        "我們不只調酒，還會研究背後的化學原理呢！"
                    ]
                });
            }
            
            createNPC(config) {
                const npc = new THREE.Group();
                
                // 身體
                const body = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.3, 0.35, 1.2),
                    new THREE.MeshPhongMaterial({ color: config.color })
                );
                body.position.y = 0.6;
                
                // 頭部
                const head = new THREE.Mesh(
                    new THREE.SphereGeometry(0.25),
                    new THREE.MeshPhongMaterial({ color: 0xfdbcb4 })
                );
                head.position.y = 1.5;
                
                // 名字標籤（使用簡單的方塊表示）
                const label = new THREE.Mesh(
                    new THREE.PlaneGeometry(1, 0.3),
                    new THREE.MeshBasicMaterial({ color: 0xffffff })
                );
                label.position.y = 2;
                
                npc.add(body);
                npc.add(head);
                npc.add(label);
                npc.position.copy(config.position);
                npc.castShadow = true;
                
                // 儲存NPC資料
                npc.userData = {
                    name: config.name,
                    dialogues: config.dialogues,
                    currentDialogue: 0
                };
                
                this.npcs.push(npc);
                this.scene.add(npc);
            }
            
            setupLighting() {
                // 環境光
                const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                this.scene.add(ambientLight);
                
                // 主要照明（模擬酒吧的暖色調燈光）
                const mainLight = new THREE.PointLight(0xffa500, 1, 15);
                mainLight.position.set(0, 6, 0);
                mainLight.castShadow = true;
                mainLight.shadow.camera.near = 0.1;
                mainLight.shadow.camera.far = 15;
                this.scene.add(mainLight);
                
                // 吧檯上方的聚光燈
                const spotLight = new THREE.SpotLight(0xffd700, 0.8);
                spotLight.position.set(0, 8, -3);
                spotLight.target.position.set(0, 0, -3);
                spotLight.castShadow = true;
                spotLight.angle = Math.PI / 6;
                spotLight.penumbra = 0.3;
                this.scene.add(spotLight);
                this.scene.add(spotLight.target);
                
                // 酒架照明
                const shelfLight = new THREE.PointLight(0x6b46c1, 0.5, 10);
                shelfLight.position.set(0, 5, -7);
                this.scene.add(shelfLight);
            }
            
            setupEventListeners() {
                // 鍵盤事件
                window.addEventListener('keydown', (e) => {
                    this.keys[e.key.toLowerCase()] = true;
                    
                    if (e.key.toLowerCase() === 'e') {
                        this.checkInteraction();
                    }
                });
                
                window.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                });
                
                // 視窗調整
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            
            updatePlayer() {
                const delta = this.clock.getDelta();
                
                // 旋轉
                if (this.keys['arrowleft']) {
                    this.player.rotation += this.player.rotationSpeed * delta;
                }
                if (this.keys['arrowright']) {
                    this.player.rotation -= this.player.rotationSpeed * delta;
                }
                
                // 計算移動方向
                const moveVector = new THREE.Vector3();
                
                if (this.keys['w']) {
                    moveVector.z -= 1;
                }
                if (this.keys['s']) {
                    moveVector.z += 1;
                }
                if (this.keys['a']) {
                    moveVector.x -= 1;
                }
                if (this.keys['d']) {
                    moveVector.x += 1;
                }
                
                // 應用旋轉到移動向量
                if (moveVector.length() > 0) {
                    moveVector.normalize();
                    moveVector.multiplyScalar(this.player.speed * delta);
                    moveVector.applyAxisAngle(new THREE.Vector3(0, 1, 0), this.player.rotation);
                    
                    // 更新位置（加入邊界檢查）
                    const newPosition = this.player.position.clone().add(moveVector);
                    if (Math.abs(newPosition.x) < 9 && Math.abs(newPosition.z) < 9) {
                        this.player.position.add(moveVector);
                    }
                }
                
                // 更新相機
                this.camera.position.copy(this.player.position);
                this.camera.rotation.y = this.player.rotation;
                
                // 檢查是否靠近NPC
                this.checkNearbyNPCs();
            }
            
            checkNearbyNPCs() {
                const interactionDistance = 2;
                let nearNPC = false;
                
                for (const npc of this.npcs) {
                    const distance = this.player.position.distanceTo(npc.position);
                    
                    if (distance < interactionDistance) {
                        nearNPC = true;
                        document.getElementById('interaction-hint').style.display = 'block';
                        break;
                    }
                }
                
                if (!nearNPC) {
                    document.getElementById('interaction-hint').style.display = 'none';
                }
            }
            
            checkInteraction() {
                const interactionDistance = 2;
                
                for (const npc of this.npcs) {
                    const distance = this.player.position.distanceTo(npc.position);
                    
                    if (distance < interactionDistance) {
                        this.showDialogue(npc);
                        break;
                    }
                }
            }
            
            showDialogue(npc) {
                const dialogueBox = document.getElementById('dialogue-box');
                const characterName = document.getElementById('character-name');
                const dialogueText = document.getElementById('dialogue-text');
                
                const userData = npc.userData;
                characterName.textContent = userData.name;
                dialogueText.textContent = userData.dialogues[userData.currentDialogue];
                
                dialogueBox.style.display = 'block';
                
                // 循環對話
                userData.currentDialogue = (userData.currentDialogue + 1) % userData.dialogues.length;
                
                // 3秒後自動隱藏
                setTimeout(() => {
                    dialogueBox.style.display = 'none';
                }, 3000);
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                this.updatePlayer();
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        // 初始化模擬器
        window.addEventListener('DOMContentLoaded', () => {
            const simulator = new BarSimulator();
        });
    </script>
</body>
</html>