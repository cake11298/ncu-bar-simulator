import * as THREE from 'three';

export class NPCManager {
    constructor(scene) {
        this.scene = scene;
        this.npcs = [];
        this.interactableObjects = [];
        this.gustaveInteractionCount = 0;
        this.audioContext = null;
        this.currentlyPlaying = null;
        this.musicPlaying = false; 
        this.musicGainNode = null;
        this.dialogueTimer = null;
        this.createNPCs();
        this.createMusicSystem();
    }
    
    createNPCs() {
        // Gustave - ÂàÜÂ≠êË™øÈÖíÂ∞àÂÆ∂
        this.addNPC({
            name: 'Gustave',
            position: new THREE.Vector3(2, 0, -5),
            shirtColor: 0x0066cc,
            pantsColor: 0x1a1a1a,
            role: 'Ë™øÈÖíÁ§æÂâµÂßãÁ§æÈï∑',
            dialogues: [
                "Âó®ÔºÅÊàëÊòØ Gustave YangÔºåNCU ÂàÜÂ≠êÂâµÊÑèÈ£≤ÂìÅÁ†îÁ©∂Á§æÁöÑÂâµËæ¶‰∫∫ÔºÅ",
                "‰Ω†Áü•ÈÅìÂóéÔºü Êõ¶Ê®Ç‰ªñÂÆ∂Ë£°ÊúâÈ§ä‰∏ÄÈöªË≤ìÔºÅ",
                "ÊàëÂÄëÁî®ÁÖôÁáªÊ©üÂ∑ÆÈªûÊääÊïôÁ†îÂ§ßÊ®ìÁáí‰∫Ü",
                "ÊÉ≥ÂÉè‰∏Ä‰∏ãÔºå‰∏äÊ¨°Êõ¶Ê®ÇÊääÊ±ΩÊ∞¥ÊèêÊó©Âä†ÂÖ•Èõ™ÂÖãÊùØÔºåÊêñÂà∞‰∏ÄÂçäÁÇ∏Èñã‰∫Ü",
                "ÂàÜÂ≠êË™øÈÖí‰∏çÂè™ÊòØÊäÄË°ìÔºåÊõ¥ÊòØÁßëÂ≠∏ËàáËóùË°ìÁöÑËûçÂêà",
                "Ëá™Áî±ÁÑ°ÂÉπ",
                "Êúâ‰∫õ‰∫ãÊÉÖ‰∏çÊòØÈù†Êó©‰∏äÁöÑ‰∏ÄÊùØÂíñÂï°Ëß£Ê±∫ÔºåËÄåÊòØÊôö‰∏äÁöÑ‰∏ÄÊùØË™øÈÖíÈÅ∫ÂøòÁöÑ",
                "ÂàÜÂ≠êË™øÈÖíÁöÑÁü•Ë≠òÈùûÂ∏∏ÂØ¨Âª£ÔºåÂÉèÊòØ...ÁóæÊàëÂøòË®ò‰∫Ü",
                "Ë™™ÈÅìÊêñÁõ™Ê≥ïÔºå‰Ω†ÈúÄË¶ÅÊúâÈªûÊÉ≥ÂÉèÂäõÔºåÊÉ≥ÂÉèÊ∂≤È´îÂú®Ë£°Èù¢ÁöÑËû∫ÊóãÊ∑∑Âíå",
                "Â¶ÇÊûúÊÑüË¶∫Âø´Êíê‰∏ç‰Ωè‰∫Ü Ë®òÂæóÂéªÁµ¶Âä†Ê≤πÁ´ô Âõ†ÁÇ∫‰ªñÂÄëÊúÉË∑ü‰Ω†Ë™™ Ë¶ÅÂä†Ê≤πÂñî!",
                "‰ªÄÈ∫º? ‰Ω†Ë™™‰Ω†ÊúâÂè£Ê∞¥ÁóÖ ‰∏äÊ¨°ÈÄôÊ®£Ë™™ÁöÑ‰∫∫Â∑≤Á∂ìÂú®Ê∫´Âì•ËèØ‰∫Ü"
            ]
        });
        
        // Seaton - Ë™øÈÖíÊäÄË°ìÂ§ßÂ∏´
        this.addNPC({
            name: 'Seaton',
            position: new THREE.Vector3(-2, 0, -5),
            shirtColor: 0xcc0066,
            pantsColor: 0x333333,
            role: 'Ë™øÈÖíÁ§æÂÖ±ÂêåÂâµËæ¶‰∫∫',
            dialogues: [
                "ÂìàÂõâÔºÅÊàëÊòØ Seaton Êõ¶Ê®ÇÔºå‰πüÊòØÁ§æÂúòÁöÑÂÖ±ÂêåÂâµËæ¶‰∫∫ÔºÅ",
                "ÊåñÂãíÔºåÈÇÑÂæó(„Ñâ„ÑüÀá)ÊòØ‰Ω†Âïä",
                "ÊàëÊúÄÂñúÊ≠°Êó•Êú¨Â®ÅÂ£´ÂøåÔºåÁâπÂà•ÊòØÂÆâÂæ∑ÊâãË£°ÈÇ£Áì∂Â±±Â¥é12Âπ¥",
                "‰ªäÂ§©Ë∂ÖÁ¥ØÔºåÂõûÂÆ∂Êâì‰∏ÄÂ†¥ÊãõÂñöÂ≥ΩË∞∑",
                "ÊàëÊúÄÂñúÊ≠°ÁöÑÊòØÁ∂ìÂÖ∏ÁöÑ Old Fashioned"
            ]
        });
        
        // ÂâµÂª∫Èü≥ÁÆ±‰∫íÂãïÁâ©‰ª∂
        this.createAmpInteraction();
    }
    
    createMusicSystem() {
        // ÂàùÂßãÂåñ Web Audio API
        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (error) {
            console.log('Web Audio API not supported');
        }
    }
    
    createAmpInteraction() {
        // Âú®Èü≥ÁÆ±‰ΩçÁΩÆÂâµÂª∫‰∏ÄÂÄã‰∫íÂãïÂçÄÂüü
        const ampInteraction = {
            position: new THREE.Vector3(8, 0, -8), // Èü≥ÁÆ±‰ΩçÁΩÆ
            radius: 2.5,
            name: 'Guitar Amplifier',
            type: 'music',
            action: () => this.playGuitarSound()
        };
        
        this.interactableObjects.push(ampInteraction);
    }
    
    playGuitarSound() {
        if (!this.audioContext) return;
        
        if (this.musicPlaying) {
            // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÂâáÂÅúÊ≠¢Èü≥Ê®Ç
            this.stopMusic();
            return;
        }
        
        // ÈñãÂßãÊí≠ÊîæÈü≥Ê®Ç
        this.startMusic();
    }

    // Êñ∞Â¢ûÔºöÈñãÂßãÊí≠ÊîæÈü≥Ê®ÇÁöÑÊñπÊ≥ï
    startMusic() {
        if (!this.audioContext) return;
        
        // ÂâµÂª∫‰∏ªÂ¢ûÁõäÁØÄÈªû
        this.musicGainNode = this.audioContext.createGain();
        this.musicGainNode.connect(this.audioContext.destination);
        this.musicGainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
        
        // Êí≠ÊîæËÉåÊôØÊóãÂæã
        this.playMelody();
        
        // Êí≠ÊîæÁØÄÊãç
        this.playDrums();
        
        this.musicPlaying = true;
        this.showMusicNotification('üéµ Èü≥Ê®ÇÊí≠Êîæ‰∏≠...', '#00ff00');
    }

    // Êñ∞Â¢ûÔºöÂÅúÊ≠¢Èü≥Ê®ÇÁöÑÊñπÊ≥ï
    stopMusic() {
        if (this.musicGainNode) {
            // Êº∏Â±§Èôç‰ΩéÈü≥ÈáèÂæåÊñ∑Èñã
            const fadeTime = 0.5;
            this.musicGainNode.gain.exponentialRampToValueAtTime(0.001, 
                this.audioContext.currentTime + fadeTime);
            
            setTimeout(() => {
                if (this.musicGainNode) {
                    this.musicGainNode.disconnect();
                    this.musicGainNode = null;
                }
            }, fadeTime * 1000);
        }
        
        this.musicPlaying = false;
        this.showMusicNotification('üîá Èü≥Ê®ÇÂ∑≤ÂÅúÊ≠¢', '#ff6600');
    }

    // Êñ∞Â¢ûÔºöÊí≠ÊîæÊóãÂæãÁöÑÊñπÊ≥ï
    playMelody() {
        const melody = [
            {note: 261.63, time: 0, duration: 0.5},    // C4
            {note: 293.66, time: 0.5, duration: 0.5},  // D4
            {note: 329.63, time: 1, duration: 0.5},    // E4
            {note: 293.66, time: 1.5, duration: 0.5},  // D4
            {note: 261.63, time: 2, duration: 1},      // C4
            {note: 392.00, time: 3, duration: 0.5},    // G4
            {note: 349.23, time: 3.5, duration: 0.5},  // F4
            {note: 329.63, time: 4, duration: 1},      // E4
        ];
        
        const startTime = this.audioContext.currentTime;
        
        melody.forEach(note => {
            const oscillator = this.audioContext.createOscillator();
            const noteGain = this.audioContext.createGain();
            
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(note.note, startTime + note.time);
            
            // Èü≥ÈáèÂåÖÁµ°
            noteGain.gain.setValueAtTime(0, startTime + note.time);
            noteGain.gain.linearRampToValueAtTime(0.4, startTime + note.time + 0.01);
            noteGain.gain.exponentialRampToValueAtTime(0.001, 
                startTime + note.time + note.duration);
            
            oscillator.connect(noteGain);
            noteGain.connect(this.musicGainNode);
            
            oscillator.start(startTime + note.time);
            oscillator.stop(startTime + note.time + note.duration);
        });
        
        // Âæ™Áí∞Êí≠Êîæ
        if (this.musicPlaying) {
            setTimeout(() => {
                if (this.musicPlaying) {
                    this.playMelody();
                }
            }, 5000);
        }
    }

    // Êñ∞Â¢ûÔºöÊí≠ÊîæÈºìÈªûÁöÑÊñπÊ≥ï
    playDrums() {
        const drumPattern = [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5]; // ÊØè0.5Áßí‰∏Ä‰∏ã
        const startTime = this.audioContext.currentTime;
        
        drumPattern.forEach(time => {
            const oscillator = this.audioContext.createOscillator();
            const drumGain = this.audioContext.createGain();
            
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(60, startTime + time); // ‰ΩéÈ†ªÈºìËÅ≤
            
            drumGain.gain.setValueAtTime(0, startTime + time);
            drumGain.gain.linearRampToValueAtTime(0.2, startTime + time + 0.01);
            drumGain.gain.exponentialRampToValueAtTime(0.001, startTime + time + 0.2);
            
            oscillator.connect(drumGain);
            drumGain.connect(this.musicGainNode);
            
            oscillator.start(startTime + time);
            oscillator.stop(startTime + time + 0.2);
        });
        
        // Âæ™Áí∞Êí≠ÊîæÈºìÈªû
        if (this.musicPlaying) {
            setTimeout(() => {
                if (this.musicPlaying) {
                    this.playDrums();
                }
            }, 4000);
        }
    }
    
    showMusicNotification(message = 'üé∏ Electric Guitar Playing...', color = '#00ff00') {
        // ÂâµÂª∫Èü≥Ê®ÇÊí≠ÊîæÈÄöÁü•
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: ${color};
            padding: 15px 20px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            font-size: 16px;
            z-index: 1000;
            border: 2px solid ${color};
            animation: fadeInOut 3s ease-in-out;
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Ê∑ªÂä† CSS ÂãïÁï´Ôºà‰øùÊåÅÂéüÊ®£Ôºâ
        if (!document.getElementById('music-notification-style')) {
            const style = document.createElement('style');
            style.id = 'music-notification-style';
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateX(100px); }
                    20% { opacity: 1; transform: translateX(0); }
                    80% { opacity: 1; transform: translateX(0); }
                    100% { opacity: 0; transform: translateX(100px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 3000);
    }
    
    addNPC(config) {
        const npc = new THREE.Group();

        // === ËªÄÂππÔºàÁôΩË•ØË°´ + ÈªëËÉåÂøÉÔºâ===
        const shirt = new THREE.Mesh(
            new THREE.CylinderGeometry(0.4, 0.45, 1.0, 16),
            new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8 })
        );
        shirt.position.y = 1.2;
        shirt.castShadow = true;

        const vest = new THREE.Mesh(
            new THREE.CylinderGeometry(0.42, 0.47, 1.0, 16, 1, true),
            new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.6 })
        );
        vest.position.y = 1.2;
        vest.castShadow = true;

        // === Ë§≤Â≠ê ===
        const pants = new THREE.Mesh(
            new THREE.CylinderGeometry(0.35, 0.35, 1.0, 16),
            new THREE.MeshStandardMaterial({ color: config.pantsColor, roughness: 0.9 })
        );
        pants.position.y = 0.2;
        pants.castShadow = true;

        // === ËÖø ===
        const leftLeg = new THREE.Mesh(
            new THREE.CylinderGeometry(0.15, 0.15, 1.0, 16),
            new THREE.MeshStandardMaterial({ color: config.pantsColor })
        );
        leftLeg.position.set(-0.18, -0.3, 0);
        leftLeg.castShadow = true;

        const rightLeg = new THREE.Mesh(
            new THREE.CylinderGeometry(0.15, 0.15, 1.0, 16),
            new THREE.MeshStandardMaterial({ color: config.pantsColor })
        );
        rightLeg.position.set(0.18, -0.3, 0);
        rightLeg.castShadow = true;

        // === ÊâãËáÇ ===
        const leftArm = new THREE.Mesh(
            new THREE.CylinderGeometry(0.12, 0.12, 0.8, 12),
            new THREE.MeshStandardMaterial({ color: 0xfdbcb4 })
        );
        leftArm.position.set(-0.55, 1.2, 0);
        leftArm.castShadow = true;

        const rightArm = new THREE.Mesh(
            new THREE.CylinderGeometry(0.12, 0.12, 0.8, 12),
            new THREE.MeshStandardMaterial({ color: 0xfdbcb4 })
        );
        rightArm.position.set(0.55, 1.2, 0);
        rightArm.castShadow = true;

        // === È†≠ÈÉ® ===
        const head = new THREE.Mesh(
            new THREE.SphereGeometry(0.35, 16, 16),
            new THREE.MeshStandardMaterial({ color: 0xfdbcb4 })
        );
        head.position.y = 2.1;
        head.castShadow = true;

        // === È†≠È´ÆÔºàÁ∞°ÂñÆÁöÑËìãÈ†ÇÔºâ===
        const hair = new THREE.Mesh(
            new THREE.SphereGeometry(0.36, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2),
            new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.7 })
        );
        hair.position.y = 2.1;
        hair.castShadow = true;

        // === È†òÁµê ===
        const bowTie = new THREE.Mesh(
            new THREE.BoxGeometry(0.3, 0.1, 0.05),
            new THREE.MeshStandardMaterial({ color: 0x990000, metalness: 0.2 })
        );
        bowTie.position.set(0, 1.7, 0.35);

        // === ÈÖíÊùØÔºàÂè≥ÊâãÔºâ===
        const glassCup = new THREE.Mesh(
            new THREE.CylinderGeometry(0.1, 0.12, 0.3, 16),
            new THREE.MeshPhysicalMaterial({ 
                color: 0xffffff, 
                transparent: true, 
                opacity: 0.4, 
                roughness: 0, 
                metalness: 0,
                transmission: 1.0, // ÁéªÁíÉÊïàÊûú
                ior: 1.5
            })
        );
        glassCup.position.set(0.75, 1.2, 0);
        glassCup.rotation.x = Math.PI / 8;

        // === ËáâÈÉ®ÔºàÁúºÁùõ + Âò¥Â∑¥Ôºâ===
        const faceGroup = new THREE.Group();
        faceGroup.position.y = 2.1;

        const leftEye = new THREE.Mesh(
            new THREE.SphereGeometry(0.05, 8, 8),
            new THREE.MeshBasicMaterial({ color: 0x000000 })
        );
        leftEye.position.set(-0.12, 0.05, 0.33);

        const rightEye = new THREE.Mesh(
            new THREE.SphereGeometry(0.05, 8, 8),
            new THREE.MeshBasicMaterial({ color: 0x000000 })
        );
        rightEye.position.set(0.12, 0.05, 0.33);

        const mouth = new THREE.Mesh(
            new THREE.TorusGeometry(0.12, 0.02, 8, 16, Math.PI),
            new THREE.MeshBasicMaterial({ color: 0x000000 })
        );
        mouth.rotation.x = Math.PI;
        mouth.position.set(0, -0.1, 0.32);

        faceGroup.add(leftEye);
        faceGroup.add(rightEye);
        faceGroup.add(mouth);

        // === ÂêçÂ≠óÊ®ôÁ±§ ===
        const nameTag = this.createNameTag(config.name, config.role);
        nameTag.position.y = 2.8;

        // === ÁµÑË£ù ===
        npc.add(shirt);
        npc.add(vest);
        npc.add(pants);
        npc.add(leftLeg);
        npc.add(rightLeg);
        npc.add(leftArm);
        npc.add(rightArm);
        npc.add(head);
        npc.add(hair);
        npc.add(bowTie);
        npc.add(glassCup);
        npc.add(faceGroup);
        npc.add(nameTag);

        npc.position.copy(config.position);

        // ÂÑ≤Â≠òË≥áÊñô
        npc.userData = {
            name: config.name,
            role: config.role,
            dialogues: config.dialogues,
            currentDialogue: 0,
            originalY: config.position.y,
            nameTagSprite: nameTag.children[0]
        };

        this.npcs.push(npc);
        this.scene.add(npc);
    }
    
    createNameTag(name, role) {
        const tagGroup = new THREE.Group();
        
        // ÂâµÂª∫ Canvas ‰æÜÁπ™Ë£ΩÊñáÂ≠ó
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = 512;
        canvas.height = 256;
        
        // Ê∏ÖÈô§Áï´Â∏É‰∏¶Ë®≠ÂÆöÈÄèÊòéËÉåÊôØ
        context.clearRect(0, 0, canvas.width, canvas.height);
        
        // Áπ™Ë£ΩÂçäÈÄèÊòéËÉåÊôØ
        context.fillStyle = 'rgba(0, 0, 0, 0.7)';
        context.roundRect = context.roundRect || function(x, y, w, h, r) {
            context.beginPath();
            context.moveTo(x + r, y);
            context.lineTo(x + w - r, y);
            context.arc(x + w - r, y + r, r, -Math.PI/2, 0);
            context.lineTo(x + w, y + h - r);
            context.arc(x + w - r, y + h - r, r, 0, Math.PI/2);
            context.lineTo(x + r, y + h);
            context.arc(x + r, y + h - r, r, Math.PI/2, Math.PI);
            context.lineTo(x, y + r);
            context.arc(x + r, y + r, r, Math.PI, -Math.PI/2);
            context.closePath();
            context.fill();
        };
        
        // Áπ™Ë£ΩÂúìËßíÁü©ÂΩ¢ËÉåÊôØ
        if (context.roundRect) {
            context.roundRect(50, 70, 412, 116, 20);
        } else {
            context.fillRect(50, 70, 412, 116);
        }
        
        // Áπ™Ë£ΩÂêçÂ≠ó
        context.fillStyle = 'white';
        context.font = 'bold 64px Arial';
        context.textAlign = 'center';
        context.textBaseline = 'middle';
        context.fillText(name, 256, 110);
        
        // Áπ™Ë£ΩËßíËâ≤ËÅ∑Á®±
        context.font = '40px Arial';
        context.fillStyle = '#FFD700';
        context.fillText(role, 256, 160);
        
        // ÂâµÂª∫ÊùêË≥™ÂíåÁ≤æÈùà
        const texture = new THREE.CanvasTexture(canvas);
        texture.needsUpdate = true;
        
        const spriteMaterial = new THREE.SpriteMaterial({ 
            map: texture,
            transparent: true,
            depthWrite: false // ÈÅøÂÖçÊ∑±Â∫¶ÂïèÈ°å
        });
        
        const sprite = new THREE.Sprite(spriteMaterial);
        sprite.scale.set(2, 1, 1);
        
        tagGroup.add(sprite);
        
        return tagGroup;
    }
    
    createSpecialDialogue(text) {
        // ÂâµÂª∫ÁâπÊÆäÁöÑÂ∞çË©±Ê°Ü
        const dialogueBox = document.createElement('div');
        dialogueBox.id = 'special-dialogue-box';
        dialogueBox.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #faca2cff, #ec692bff);
            color: white;
            padding: 30px 40px;
            border-radius: 15px;
            font-family: Arial, sans-serif;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            border: 3px solid #ffffff;
            box-shadow: 0 0 30px rgba(255, 0, 102, 0.5);
            max-width: 600px;
            animation: specialPulse 2s infinite;
        `;
        
        const characterName = document.createElement('div');
        characterName.style.cssText = `
            font-size: 20px;
            color: #ffff00;
            margin-bottom: 15px;
        `;
        characterName.textContent = 'Gustave Êô∫ÂÆá';
        
        const dialogueText = document.createElement('div');
        dialogueText.style.cssText = `
            margin-bottom: 20px;
            line-height: 1.4;
        `;
        dialogueText.textContent = text;
        
        const closeButton = document.createElement('div');
        closeButton.style.cssText = `
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 25px;
            padding: 10px 20px;
            cursor: pointer;
            display: inline-block;
            font-size: 16px;
            transition: all 0.3s ease;
        `;
        closeButton.textContent = 'Êåâ‰∏ã X ÈóúÈñâ';
        closeButton.addEventListener('mouseenter', () => {
            closeButton.style.background = 'rgba(255, 255, 255, 0.4)';
        });
        closeButton.addEventListener('mouseleave', () => {
            closeButton.style.background = 'rgba(255, 255, 255, 0.2)';
        });
        
        dialogueBox.appendChild(characterName);
        dialogueBox.appendChild(dialogueText);
        dialogueBox.appendChild(closeButton);
        
        // Ê∑ªÂä†ÁâπÊÆäÂãïÁï´ CSS
        if (!document.getElementById('special-dialogue-style')) {
            const style = document.createElement('style');
            style.id = 'special-dialogue-style';
            style.textContent = `
                @keyframes specialPulse {
                    0% { box-shadow: 0 0 30px rgba(255, 0, 102, 0.5); }
                    50% { box-shadow: 0 0 50px rgba(255, 102, 0, 0.8); }
                    100% { box-shadow: 0 0 30px rgba(255, 0, 102, 0.5); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(dialogueBox);
        
        // Áõ£ËÅΩ X ÈçµÈóúÈñâ
        const closeHandler = (e) => {
            if (e.key.toLowerCase() === 'x') {
                document.body.removeChild(dialogueBox);
                document.removeEventListener('keydown', closeHandler);
            }
        };
        document.addEventListener('keydown', closeHandler);
        
        // ÈªûÊìäÈóúÈñâÊåâÈàï‰πüËÉΩÈóúÈñâ
        closeButton.addEventListener('click', () => {
            document.body.removeChild(dialogueBox);
            document.removeEventListener('keydown', closeHandler);
        });
    }
    
    checkInteractions(playerPosition) {
        const interactionDistance = 2.5;
        let nearNPC = false;
        let closestNPC = null;
        let minDistance = Infinity;
        
        // Ê™¢Êü• NPC ‰∫íÂãï
        for (const npc of this.npcs) {
            const distance = playerPosition.distanceTo(npc.position);
            
            if (distance < interactionDistance) {
                nearNPC = true;
                if (distance < minDistance) {
                    minDistance = distance;
                    closestNPC = npc;
                }
            }
        }
        
        // Ê™¢Êü•ÂÖ∂‰ªñ‰∫íÂãïÁâ©‰ª∂ÔºàÂ¶ÇÈü≥ÁÆ±Ôºâ
        let nearInteractable = false;
        let closestInteractable = null;
        
        for (const obj of this.interactableObjects) {
            const distance = playerPosition.distanceTo(obj.position);
            
            if (distance < obj.radius) {
                nearInteractable = true;
                if (!closestNPC || distance < minDistance) {
                    closestInteractable = obj;
                }
            }
        }
        
        // Êõ¥Êñ∞‰∫íÂãïÊèêÁ§∫
        const hint = document.getElementById('interaction-hint');
        if (hint) {
            if (nearNPC || nearInteractable) {
                hint.classList.add('active');
                if (closestInteractable) {
                    if (closestInteractable.type === 'music') {
                        const action = this.musicPlaying ? 'ÈóúÈñâÈü≥Ê®Ç' : 'Êí≠ÊîæÈü≥Ê®Ç';
                        hint.textContent = `Êåâ‰∏ã E ${action}`;
                    } else {
                        hint.textContent = `Êåâ‰∏ã E Ëàá ${closestInteractable.name} ‰∫íÂãï`;
                    }
                } else if (closestNPC) {
                    hint.textContent = `Êåâ‰∏ã E Ëàá ${closestNPC.userData.name} ‰∫§Ë´á`;
                }
            } else {
                hint.classList.remove('active');
            }
        }
        
        return { npc: closestNPC, interactable: closestInteractable };
    }
    
    interact(target) {
        if (target.npc) {
            this.interactWithNPC(target.npc);
        } else if (target.interactable) {
            this.interactWithObject(target.interactable);
        }
    }
    
    interactWithNPC(npc) {
        if (!npc) return;
        
        const userData = npc.userData;
        
        // ÁâπÂà•ËôïÁêÜ Gustave ÁöÑ‰∫íÂãïË®àÊï∏
        if (userData.name === 'Gustave') {
            this.gustaveInteractionCount++;
            
            if (this.gustaveInteractionCount == 100) {
                const hiddenName = "\u9EC3\u6B63\u5B89";
                this.createSpecialDialogue(`${hiddenName}Ôºü Âà•ÂÜçÊåâ‰∫ÜÔºÅÔºÅÔºÅ`);
                return;
            }
            if (this.gustaveInteractionCount == 200) {
                const hiddenName = "\u9EC3\u6B63\u5B89";
                this.createSpecialDialogue(`${hiddenName}Ôºü ÈõñÁÑ∂ÈÄôÊòØÊàëÁïôÁöÑÂ∞èÂøÉÊÄù ‰ΩÜÂà•ÂÜçÊåâ‰∫ÜÔºÅÔºÅÔºÅ \u6211\u4ec0\u9ebc\u90fd\u4e0d\u6703\u8aaa\u7684`);
                return;
            }
            if (this.gustaveInteractionCount == 300) {
                this.createSpecialDialogue(`‰Ω†Âà∞Â∫ïÊòØÊúâÂ§öÁÑ°ËÅäÂïäÔºü \u4e0d\u8981\u5728\u9019\u88e1\u57f7\u8457\u4e86!`);
                return;
            }
        }
        
        const dialogueBox = document.getElementById('dialogue-box');
        const characterName = document.getElementById('character-name');
        const dialogueText = document.getElementById('dialogue-text');
        
        if (!dialogueBox || !characterName || !dialogueText) return;
        
        // Á´ãÂç≥Ë®≠ÁΩÆÊñ∞ÁöÑÂ∞çË©±ÂÖßÂÆπ
        characterName.textContent = `${userData.name} - ${userData.role}`;
        dialogueText.textContent = userData.dialogues[userData.currentDialogue];
        
        // Âº∑Âà∂È°ØÁ§∫Â∞çË©±Ê°ÜÔºàÁßªÈô§ÂæåÁ´ãÂç≥Ê∑ªÂä†ÔºåËß∏ÁôºÈáçÊñ∞ÂãïÁï´Ôºâ
        dialogueBox.classList.remove('active');
        // Âº∑Âà∂ÁÄèË¶ΩÂô®ÈáçÁπ™ÔºåÁ¢∫‰øù remove ÁîüÊïà
        dialogueBox.offsetHeight;
        dialogueBox.classList.add('active');
        
        // Âæ™Áí∞Â∞çË©±
        userData.currentDialogue = (userData.currentDialogue + 1) % userData.dialogues.length;
        
        // ÂâµÂª∫ÈÄôÊ¨°Â∞çË©±Â∞àÂ±¨ÁöÑË®àÊôÇÂô®Ôºå‰∏çÁÆ°ÁêÜ‰ªª‰ΩïÂÖ®Â±ÄË®àÊôÇÂô®
        setTimeout(() => {
            // Âè™ÊúâÂú®Â∞çË©±Ê°Ü‰ªçÁÑ∂È°ØÁ§∫Áõ∏ÂêåÂÖßÂÆπÊôÇÊâçÈö±Ëóè
            // ÈÄöÈÅéÊ™¢Êü•ÂÖßÂÆπ‰æÜÁ¢∫‰øùÈÄôÊòØÂêå‰∏ÄÊ¨°Â∞çË©±
            const currentName = characterName.textContent;
            const currentText = dialogueText.textContent;
            
            if (currentName === `${userData.name} - ${userData.role}` && 
                currentText === userData.dialogues[(userData.currentDialogue - 1 + userData.dialogues.length) % userData.dialogues.length]) {
                dialogueBox.classList.remove('active');
            }
        }, 4000);
    }
    
    interactWithObject(obj) {
        if (obj.type === 'music') {
            obj.action();
        }
    }
    
    update(deltaTime) {
        // ËÆì NPC ÊúâÁ∞°ÂñÆÁöÑÂãïÁï´
        this.npcs.forEach((npc, index) => {
            // ËºïÂæÆÁöÑ‰∏ä‰∏ãÊµÆÂãï
            const floatY = Math.sin(Date.now() * 0.001 + index) * 0.02;
            npc.position.y = npc.userData.originalY + floatY;
            
            // ËºïÂæÆÁöÑÂ∑¶Âè≥ÊêñÊì∫
            npc.rotation.y = Math.sin(Date.now() * 0.0008 + index * 2) * 0.05;
            
            // ËÆìÂêçÂ≠óÊ®ôÁ±§ÂßãÁµÇÈù¢ÂêëÁõ∏Ê©üÔºàSprite ÊúÉËá™ÂãïÈù¢ÂêëÁõ∏Ê©üÔºâ
        });
    }
}